<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentAgency Research UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .editable {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
            width: 100%;
            resize: vertical;
        }

        .editable:focus {
            outline: 2px solid #667eea;
            background: white;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 15px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results {
            grid-column: 1 / -1;
        }

        .result-content {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
            max-height: 600px;
            overflow-y: auto;
            line-height: 1.8;
        }

        .result-content h1, .result-content h2, .result-content h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .result-content h1 {
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .result-content h2 {
            font-size: 1.4em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .result-content h3 {
            font-size: 1.2em;
        }

        .result-content ul, .result-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .result-content li {
            margin-bottom: 8px;
        }

        .result-content strong {
            color: #495057;
            font-weight: 600;
        }

        .result-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px dotted #667eea;
        }

        .result-content a:hover {
            color: #764ba2;
            border-bottom: 1px solid #764ba2;
        }

        .result-content p {
            margin-bottom: 12px;
        }

        .result-content code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .suggestion-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .suggestion-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .suggestion-title {
            color: #667eea;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .suggestion-description {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .suggestion-meta {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .meta-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .meta-label {
            font-weight: 600;
            color: #6c757d;
            min-width: 80px;
        }

        .meta-value {
            color: #495057;
            flex: 1;
        }

        .platform-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .platform-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .engagement-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .engagement-high {
            background: #d4edda;
            color: #155724;
        }

        .engagement-moderate {
            background: #fff3cd;
            color: #856404;
        }

        .engagement-low {
            background: #f8d7da;
            color: #721c24;
        }

        .resource-links {
            margin-top: 12px;
        }

        .resource-link {
            display: block;
            color: #667eea;
            text-decoration: none;
            padding: 6px 0;
            border-bottom: 1px dotted #667eea;
            transition: color 0.2s;
        }

        .resource-link:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .resource-date {
            color: #6c757d;
            font-size: 0.85em;
            margin-left: 8px;
        }

        .trending-summary {
            background: #e7f1ff;
            border-left: 4px solid #667eea;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .trending-summary h3 {
            color: #667eea;
            margin-bottom: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timestamp {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .interest-item {
            background: #e7f1ff;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .interest-topic {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .interest-subtopics {
            color: #6c757d;
            font-size: 0.9em;
        }

        .post-item {
            background: #fff3cd;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        }

        .post-platform {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .post-title {
            font-weight: bold;
            margin: 5px 0;
        }

        .post-topics {
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 5px;
            font-style: italic;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ ContentAgency Research UI</h1>
            <p class="subtitle">Test your research agent locally with editable interests and posts</p>
        </header>

        <div class="grid">
            <!-- User Interests Section -->
            <div class="card">
                <h2>üìä User Interests</h2>
                <div id="interests-display">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="btn-group">
                    <button onclick="editInterests()">‚úèÔ∏è Edit JSON</button>
                    <button onclick="saveInterests()" style="display:none;" id="saveInterestsBtn">üíæ Save Changes</button>
                </div>
                <div id="interests-success" class="success-message"></div>
            </div>

            <!-- Recent Posts Section -->
            <div class="card">
                <h2>üìù Recent Posts</h2>
                <div id="posts-display">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="btn-group">
                    <button onclick="editPosts()">‚úèÔ∏è Edit JSON</button>
                    <button onclick="savePosts()" style="display:none;" id="savePostsBtn">üíæ Save Changes</button>
                </div>
                <div id="posts-success" class="success-message"></div>
            </div>

            <!-- Run Research Section -->
            <div class="card results">
                <h2>üîç Run Research Agent</h2>
                <p>Click the button below to run the brainstorming crew with the current interests and posts data.</p>
                <button onclick="runBrainstorm()" id="runBtn">üöÄ Run Brainstorm Crew</button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Running brainstorming crew... This may take a minute.</p>
                </div>

                <div id="results-container" style="display:none;">
                    <h3 style="margin-top: 20px; color: #667eea;">Latest Results:</h3>
                    <div class="timestamp" id="results-timestamp"></div>
                    <div class="result-content" id="results-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {
            user_interests: null,
            recent_posts: null
        };

        // Load initial data
        async function loadData() {
            const response = await fetch('/api/data');
            const data = await response.json();
            currentData = data;
            displayInterests(data.user_interests);
            displayPosts(data.recent_posts);

            // Display latest result if available
            if (data.brainstorm_results && data.brainstorm_results.sessions && data.brainstorm_results.sessions.length > 0) {
                const latestSession = data.brainstorm_results.sessions[data.brainstorm_results.sessions.length - 1];
                displayResults(latestSession);
            }
        }

        function displayInterests(interests) {
            const container = document.getElementById('interests-display');
            if (!interests || !interests.interests) {
                container.innerHTML = '<p>No interests data available</p>';
                return;
            }

            let html = '';
            interests.interests.forEach(interest => {
                html += `
                    <div class="interest-item">
                        <div class="interest-topic">${interest.topic}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayPosts(postsData) {
            const container = document.getElementById('posts-display');
            if (!postsData || !postsData.posts) {
                container.innerHTML = '<p>No posts data available</p>';
                return;
            }

            let html = '';
            postsData.posts.slice(0, 5).forEach(post => {
                html += `
                    <div class="post-item">
                        <span class="post-platform">${post.platform || 'unknown'}</span>
                        ${post.title ? `<div class="post-title">${post.title}</div>` : ''}
                        <div>${(post.content || '').substring(0, 100)}...</div>
                        <div class="post-topics">${(post.topics || []).join(', ')}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function editInterests() {
            const container = document.getElementById('interests-display');
            const json = JSON.stringify(currentData.user_interests, null, 2);
            container.innerHTML = `<textarea class="editable" id="interests-editor" rows="15">${json}</textarea>`;
            document.getElementById('saveInterestsBtn').style.display = 'inline-block';
        }

        function editPosts() {
            const container = document.getElementById('posts-display');
            const json = JSON.stringify(currentData.recent_posts, null, 2);
            container.innerHTML = `<textarea class="editable" id="posts-editor" rows="15">${json}</textarea>`;
            document.getElementById('savePostsBtn').style.display = 'inline-block';
        }

        async function saveInterests() {
            try {
                const editor = document.getElementById('interests-editor');
                const json = JSON.parse(editor.value);

                const response = await fetch('/api/update-interests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(json)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                currentData.user_interests = json;
                displayInterests(json);
                document.getElementById('saveInterestsBtn').style.display = 'none';

                const msg = document.getElementById('interests-success');
                msg.textContent = '‚úÖ Interests saved successfully!';
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 3000);
            } catch (error) {
                alert('Error saving interests: ' + error.message);
            }
        }

        async function savePosts() {
            try {
                const editor = document.getElementById('posts-editor');
                const json = JSON.parse(editor.value);

                const response = await fetch('/api/update-posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(json)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                currentData.recent_posts = json;
                displayPosts(json);
                document.getElementById('savePostsBtn').style.display = 'none';

                const msg = document.getElementById('posts-success');
                msg.textContent = '‚úÖ Posts saved successfully!';
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 3000);
            } catch (error) {
                alert('Error saving posts: ' + error.message);
            }
        }

        async function runBrainstorm() {
            const runBtn = document.getElementById('runBtn');
            const loading = document.getElementById('loading');
            const resultsContainer = document.getElementById('results-container');

            runBtn.disabled = true;
            loading.classList.add('active');
            resultsContainer.style.display = 'none';

            try {
                const response = await fetch('/api/run-brainstorm', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    displayResults(result.result);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error running brainstorm: ' + error.message);
            } finally {
                runBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        function parseMarkdown(text) {
            // Simple markdown parser
            let html = text;

            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Line breaks - convert double newlines to paragraphs
            const paragraphs = html.split(/\n\n+/);
            html = paragraphs.map(p => {
                if (p.trim().startsWith('<h') || p.trim().startsWith('<ul') || p.trim().startsWith('<ol')) {
                    return p;
                }
                return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
            }).join('\n');

            // Lists (simple implementation)
            html = html.replace(/^\s*[-*]\s+(.*)$/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/^\s*\d+\.\s+(.*)$/gim, '<li>$1</li>');

            return html;
        }

        function displayResults(session) {
            const container = document.getElementById('results-container');
            const timestamp = document.getElementById('results-timestamp');
            const content = document.getElementById('results-content');

            const date = new Date(session.timestamp);
            timestamp.textContent = `Generated: ${date.toLocaleString()}`;

            // Check if we have structured suggestions
            if (session.suggestions && Array.isArray(session.suggestions)) {
                content.innerHTML = renderStructuredSuggestions(session);
            } else if (session.suggested_topics) {
                // Fallback for old markdown format
                content.innerHTML = parseMarkdown(session.suggested_topics);
            } else {
                content.innerHTML = '<p>No results available</p>';
            }

            container.style.display = 'block';
        }

        function renderStructuredSuggestions(session) {
            let html = '<div class="suggestions-grid">';

            session.suggestions.forEach(suggestion => {
                const engagementClass = `engagement-${suggestion.engagement_potential.toLowerCase()}`;

                html += `
                    <div class="suggestion-card">
                        <div class="suggestion-title">${suggestion.title}</div>
                        <div class="suggestion-description">${suggestion.description}</div>

                        <div class="suggestion-meta">
                            <div class="meta-row">
                                <span class="meta-label">Platforms:</span>
                                <div class="platform-tags">
                                    ${suggestion.platform_fit.map(p => `<span class="platform-tag">${p}</span>`).join('')}
                                </div>
                            </div>

                            <div class="meta-row">
                                <span class="meta-label">Alignment:</span>
                                <span class="meta-value">${suggestion.interest_alignment}</span>
                            </div>

                            <div class="meta-row">
                                <span class="meta-label">Trend:</span>
                                <span class="meta-value">${suggestion.trend_connection}</span>
                            </div>

                            <div class="meta-row">
                                <span class="meta-label">Engagement:</span>
                                <span class="meta-value">
                                    <span class="engagement-badge ${engagementClass}">${suggestion.engagement_potential}</span>
                                    <br><small>${suggestion.engagement_reason}</small>
                                </span>
                            </div>

                            ${suggestion.resource_links && suggestion.resource_links.length > 0 ? `
                                <div class="meta-row">
                                    <span class="meta-label">Resources:</span>
                                    <div class="resource-links">
                                        ${suggestion.resource_links.map(link => `
                                            <a href="${link.url}" class="resource-link" target="_blank">
                                                ${link.title}
                                                ${link.published_date ? `<span class="resource-date">(${link.published_date})</span>` : ''}
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Add trending context summary if available
            if (session.trending_context_summary) {
                html += `
                    <div class="trending-summary">
                        <h3>üìà Trending Context Summary</h3>
                        <div>${session.trending_context_summary}</div>
                    </div>
                `;
            }

            return html;
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
